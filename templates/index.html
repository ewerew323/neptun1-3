<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <title>Тривоги України — Карта</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root {
      /* Основная цветовая схема */
      --main-bg: #0d1117;
      --panel-bg: #161b22;
      --card-bg: #21262d;
      --accent: #ff4444;
      --accent2: #ffd700;
      --text: #ffffff;
      --text2: #8b949e;
      --border: #30363d;
      --shadow: rgba(0, 0, 0, 0.4);

      /* Цвета для угроз */
      --threat-shahed: #ff4444;
      --threat-raketa: #3b82f6;
      --threat-avia: #ffd700;
      
      /* Статусы */
      --status-active: #ff4444;
      --status-warning: #ffd700;
      --status-safe: #4ade80;
      
      /* Размеры */
      --header-height: 60px;
      --sidebar-width: 320px;
      --card-radius: 12px;
      --transition: 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Montserrat', system-ui, -apple-system, sans-serif;
      background: var(--main-bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
      line-height: 1.5;
    }

    .app-container {
      display: grid;
      grid-template-columns: var(--sidebar-width) 1fr;
      grid-template-rows: var(--header-height) 1fr;
      min-height: 100vh;
    }

    .navbar {
      grid-column: 1 / -1;
      background: var(--panel-bg);
      color: var(--text);
      padding: 0 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 1px 3px var(--shadow);
      z-index: 1000;
      justify-content: space-between;
      border-bottom: 2px solid var(--accent2);
      position: sticky;
      top: 0;
      z-index: 20;
    }
    .navbar .logo {
      display: flex;
      align-items: center;
      gap: 18px;
    }
    .navbar .logo img {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: #e0e4ea;
      box-shadow: 0 2px 8px #23272f22;
    }
    .navbar .nav-links {
      display: flex;
      gap: 24px;
      font-size: 1.1rem;
    }
    .navbar .nav-links a {
      color: var(--text2);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s;
    }
    .navbar .nav-links a:hover {
      color: var(--accent2);
    }
    .main-content {
      display: flex;
      flex-wrap: wrap;
      gap: 32px;
      justify-content: center;
      align-items: flex-start;
      margin: 32px auto 0 auto;
      max-width: 100vw;
      padding: 0 2px;
    }
    .card {
      background: var(--card-bg);
      border-radius: 18px;
      box-shadow: 0 8px 32px var(--shadow);
      padding: 28px 32px 24px 32px;
      max-width: 360px;
      flex: 1 1 320px;
      backdrop-filter: var(--card-blur);
      border: 1.5px solid var(--border);
      margin-bottom: 24px;
    }
    .card h2 {
      margin-top: 0;
      font-size: 1.5rem;
      color: var(--accent2);
      letter-spacing: 1px;
      margin-bottom: 18px;
    }
    .card .event-list {
      max-height: 420px;
      overflow-y: auto;
      padding-right: 6px;
    }
    .event {
      background: var(--panel-bg);
      border-radius: var(--card-radius);
      margin-bottom: 1rem;
      padding: 1rem;
      box-shadow: 0 2px 8px var(--shadow);
      display: flex;
      gap: 1rem;
      align-items: flex-start;
      border: 1px solid var(--border);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .event::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: var(--accent2);
      border-radius: 2px;
    }

    .event:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--shadow);
      border-color: var(--accent2);
    }

    .event:last-child {
      margin-bottom: 0;
    }

    .event .event-icon {
      width: 32px;
      height: 32px;
      padding: 4px;
      background: rgba(255, 215, 0, 0.1);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .event .event-icon img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      filter: drop-shadow(0 0 4px var(--accent2));
    }

    .event .event-info {
      flex: 1;
    }

    .event .event-title {
      font-weight: 500;
      color: var(--text);
      margin-bottom: 0.25rem;
      font-size: 1rem;
      line-height: 1.4;
    }

    .event .event-description {
      color: var(--text2);
      font-size: 0.9rem;
      line-height: 1.5;
      margin-bottom: 0.5rem;
    }

    .event .event-time {
      font-size: 0.85rem;
      color: var(--text2);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .event .event-time .material-icons {
      font-size: 1rem;
      opacity: 0.7;
    }

    .event[data-type="shahed"] {
      border-color: var(--threat-shahed);
    }

    .event[data-type="raketa"] {
      border-color: var(--threat-raketa);
    }

    .event[data-type="avia"] {
      border-color: var(--threat-avia);
    }
    .filter-group {
      background: var(--card-bg);
      border-radius: var(--card-radius);
      padding: 1rem;
      margin-bottom: 1rem;
      border: 1px solid var(--border);
    }

    .filter-group label {
      display: block;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text2);
      margin-bottom: 0.5rem;
    }

    .filter-group input,
    .filter-group select {
      width: 100%;
      padding: 0.75rem;
      background: var(--panel-bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .filter-group input:focus,
    .filter-group select:focus {
      border-color: var(--accent2);
      box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.2);
      outline: none;
    }

    .select-styled {
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%238b949e'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 0.7rem center;
      background-size: 1.5em;
    }

    .range-slider {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: var(--border);
      outline: none;
      margin: 10px 0;
    }

    .range-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--accent2);
      cursor: pointer;
      box-shadow: 0 0 8px rgba(255, 215, 0, 0.4);
      transition: all 0.3s ease;
    }

    .range-slider::-webkit-slider-thumb:hover {
      transform: scale(1.1);
    }

    .range-value {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      background: var(--panel-bg);
      border-radius: 4px;
      margin-left: 0.5rem;
      font-size: 0.9rem;
      color: var(--text2);
    }

    .update-btn {
      width: 100%;
      padding: 0.75rem;
      background: var(--accent2);
      color: var(--main-bg);
      border: none;
      border-radius: var(--card-radius);
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: all 0.3s ease;
    }

    .update-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
    }
    .filters {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .filters .filter-group {
      background: var(--panel-bg);
      border-radius: var(--card-radius);
      padding: 1rem;
      border: 1px solid var(--border);
    }

    .filters .filter-group label {
      display: block;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text2);
      margin-bottom: 0.5rem;
    }

    .filters .styled-input,
    .filters .select-styled {
      width: 100%;
      padding: 0.75rem;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .filters .styled-input:focus,
    .filters .select-styled:focus {
      border-color: var(--accent2);
      box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.2);
      outline: none;
    }

    .filters .update-btn {
      width: 100%;
      padding: 0.75rem;
      background: var(--accent2);
      color: var(--main-bg);
      border: none;
      border-radius: var(--card-radius);
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: all 0.3s ease;
    }

    .filters .update-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
    }
    .map-card {
      min-width: 1000px;
      max-width: 100vw;
      flex: 5 1 1400px;
      padding: 0;
      overflow: hidden;
      background: none;
      box-shadow: none;
      border: none;
      margin-right: 0;
    }
    #map {
      height: 85vh;
      min-height: 600px;
      width: 100%;
      border-radius: 18px;
      box-shadow: 0 8px 32px #0002;
      margin: 0 auto 0 auto;
      border: 2px solid var(--accent2);
    }

    /* Боковая панель */
    .sidebar {
      background: var(--panel-bg);
      padding: 1rem;
      overflow-y: auto;
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    /* Карта */
    .map-container {
      width: 100%;
      height: calc(100vh - var(--header-height));
      background: var(--main-bg);
    }

    /* Компоненты UI */
    .card {
      background: var(--card-bg);
      border-radius: var(--card-radius);
      padding: 1rem;
      box-shadow: 0 4px 6px var(--shadow);
    }

    .alert-indicator {
      display: flex;
      align-items: center;
      padding: 0.75rem;
      background: var(--card-bg);
      border-radius: var(--card-radius);
      margin-bottom: 0.5rem;
      border: 1px solid var(--border);
      transition: var(--transition);
    }

    .alert-indicator:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--shadow);
    }

    .alert-indicator .status {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 0.75rem;
    }

    .alert-indicator.active .status {
      background: var(--status-active);
      box-shadow: 0 0 12px var(--status-active);
    }

    .alert-indicator.warning .status {
      background: var(--status-warning);
      box-shadow: 0 0 12px var(--status-warning);
    }

    .alert-indicator.safe .status {
      background: var(--status-safe);
    }

    /* Кнопки и элементы управления */
    .btn {
      background: var(--accent);
      color: var(--text);
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: var(--card-radius);
      cursor: pointer;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      transition: var(--transition);
    }

    .btn:hover {
      filter: brightness(1.1);
      transform: translateY(-1px);
    }

    .update-btn {
      width: 100%;
      background: var(--accent2);
      color: var(--panel-bg);
      font-weight: 600;
    }

    /* Адаптивный дизайн */
    @media (max-width: 1024px) {
      .app-container {
        grid-template-columns: 1fr;
      }

      .sidebar {
        position: fixed;
        left: 0;
        top: var(--header-height);
        width: var(--sidebar-width);
        height: calc(100vh - var(--header-height));
        transform: translateX(-100%);
        transition: transform var(--transition);
        z-index: 900;
      }

      .sidebar.active {
        transform: translateX(0);
      }

      .mobile-menu-btn {
        display: block;
      }
    }

    @media (max-width: 768px) {
      :root {
        --sidebar-width: 280px;
      }

      .navbar {
        padding: 0 1rem;
      }

      .logo-text {
        font-size: 1.25rem;
      }

      .nav-links {
        display: none;
      }

      .map-container {
        height: calc(100vh - var(--header-height));
      }
    }

    @media (max-width: 480px) {
      :root {
        --sidebar-width: 100%;
      }

      .card {
        padding: 0.75rem;
      }

      .alert-indicator {
        padding: 0.5rem;
      }
    }
  </style>

  <!-- Скрипт для мобильного меню -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
      const sidebar = document.querySelector('.sidebar');
      const mobileMenu = document.querySelector('.mobile-menu');
      
      mobileMenuBtn.addEventListener('click', () => {
        sidebar.classList.toggle('active');
        document.body.classList.toggle('menu-open');
      });

      // Закрытие меню при клике вне его
      document.addEventListener('click', (e) => {
        if (!sidebar.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
          sidebar.classList.remove('active');
          document.body.classList.remove('menu-open');
        }
      });
    });
  </script>
</head>
<body>
  <div class="navbar">
    <div class="logo">
      <img src="/static/shahed.png" alt="logo">
      <span>Тривоги України</span>
    </div>
    <div class="nav-links">
      <a href="#map">Карта</a>
      <a href="#events">Останні події</a>
      <a href="#about">Про проєкт</a>
    </div>
  </div>
  <div class="main-content">
    <div class="map-card card">
      <div id="map"></div>
    </div>
    <div class="card" id="events">
      <h2>Останні події</h2>
      <div class="filters">
        <div class="filter-group">
          <label for="timeRange">Час (хв):</label>
          <input type="number" id="timeRange" value="20" min="1" max="120" class="styled-input">
        </div>
        <div class="filter-group">
          <label for="threatTypeSelect">Тип загрози:</label>
          <select id="threatTypeSelect" class="select-styled">
            <option value="">Всі</option>
            <option value="shahed">Шахед/дрон</option>
            <option value="raketa">Ракета</option>
            <option value="avia">Авіація</option>
          </select>
        </div>
        <button class="update-btn" onclick="updateMarkers()">
          <span class="material-icons">refresh</span>
          Оновити
        </button>
      </div>
      <div class="event-list" id="eventList"></div>
    </div>
    <div class="card" id="about">
      <h2>Про проєкт</h2>
      <p>Цей сайт відображає актуальні тривоги та загрози по Україні. Дані оновлюються автоматично. <br><br> <b>Всі координати та типи загроз визначаються автоматично, можливі похибки.</b></p>
      <p>Розробка: <a href="https://t.me/+zFxu_4W_ishiNjli" target="_blank">НЕПТУН</a></p>
    </div>
  </div>
  <script>
    let map;
    let markers = [];
    let circles = [];
    let markerData = [];
    const ICONS = {
      shahed: '/static/shahed.png',
      raketa: '/static/raketa.png',
      avia: 'data:image/svg+xml;utf8,<svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="16" cy="16" r="16" fill="%23fbc02d"/><path d="M8 24l8-16 8 16H8z" fill="%23fff"/></svg>',
      default: '/static/shahed.png'
    };
    async function updateMarkers() {
      const timeRange = document.getElementById('timeRange').value || 20;
      let threatType = document.getElementById('threatTypeSelect').value;
      const params = new URLSearchParams({ timeRange, confRange: 0 });
      const res = await fetch(`/data?${params.toString()}`);
      const data = await res.json();
      let points = (data.tracks || []).filter(p => {
        if (typeof p.lat !== 'number' || typeof p.lng !== 'number') return false;
        if (isNaN(p.lat) || isNaN(p.lng)) return false;
        // Исключаем "нулевые" и явно ошибочные координаты
        if (Math.abs(p.lat) < 1 && Math.abs(p.lng) < 1) return false;
        // Грубая фильтрация: только Украина
        if (p.lat < 43 || p.lat > 53.5 || p.lng < 21 || p.lng > 41) return false;
        return true;
      });
      // --- Траектории ---
      if (window.trajectories) window.trajectories.forEach(line => line.setMap(null));
      window.trajectories = [];
      // Очистить круги покрытия
      if (circles.length) circles.forEach(c => c.setMap(null));
      circles = [];
      if (Array.isArray(data.trajectories)) {
        data.trajectories.forEach(traj => {
          if (traj.length > 1) {
            const path = traj.map(([lat, lng]) => ({ lat, lng }));
            const poly = new google.maps.Polyline({
              path,
              geodesic: true,
              strokeColor: '#e53935',
              strokeOpacity: 0.5,
              strokeWeight: 2,
              icons: [{
                icon: {
                  path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                  scale: 2.5,
                  strokeColor: '#e53935',
                  fillColor: '#e53935',
                  fillOpacity: 1
                },
                offset: '100%'
              }]
            });
            poly.setMap(map);
            window.trajectories.push(poly);
          }
        });
      }
      if (threatType) points = points.filter(p => (p.threat_type || '').toLowerCase() === threatType);
      // Очистить карту
      markers.forEach(m => m.setMap(null));
      markers = [];
      markerData = points;
      // Добавить маркеры
      points.forEach((p, idx) => {
        // --- Фильтр: не отображать "відбій"/"отбой" тревоги ---
        if (/відбій|отбой/i.test(p.text)) return;
        let iconUrl = ICONS[p.threat_type] || ICONS.default;
        if (p.marker_icon) {
          if (p.marker_icon.startsWith('http') || p.marker_icon.startsWith('/')) {
            iconUrl = p.marker_icon;
          } else {
            iconUrl = '/static/' + p.marker_icon;
          }
        }
        let marker, line, animationId;
        // --- Радиус покрытия по типу угрозы ---
        let radius = 0;
        let color = '#e53935';
        let fillOpacity = 0.18;
        if (p.threat_type === 'shahed') { radius = 10000; color = '#e53935'; fillOpacity = 0.18; }
        else if (p.threat_type === 'raketa') { radius = 20000; color = '#1976d2'; fillOpacity = 0.13; }
        else if (p.threat_type === 'avia') { radius = 30000; color = '#fbc02d'; fillOpacity = 0.10; }

        // --- Анимированный пульсирующий круг (эффект радара) ---
        const pulseCircle = new google.maps.Circle({
          strokeColor: '#00ffe7',
          strokeOpacity: 0.7,
          strokeWeight: 2,
          fillColor: color,
          fillOpacity: 0.38,
          map,
          center: { lat: p.lat, lng: p.lng },
          radius: radius * 0.7,
          zIndex: 0
        });
        circles.push(pulseCircle);
        let pulseStart = Date.now() + idx * 200;
        function animatePulse() {
          const t = ((Date.now() - pulseStart) % 1600) / 1600;
          const r = radius * (0.7 + 0.7 * t);
          const op = 0.38 * (1 - t);
          pulseCircle.setRadius(r);
          pulseCircle.setOptions({ fillOpacity: op });
          if (pulseCircle.getMap()) requestAnimationFrame(animatePulse);
        }
        if (radius > 0) animatePulse();
        // --- Анимация и прогноз траектории для шахедов с направлением ---
        if (p.threat_type === 'shahed') {
          // Если нет lat2/lng2 — двигаем на запад
          let lat1 = p.lat, lng1 = p.lng;
          let lat2 = (typeof p.lat2 === 'number') ? p.lat2 : lat1;
          let lng2 = (typeof p.lng2 === 'number') ? p.lng2 : (lng1 - 0.5); // 0.5 градуса ≈ 35-40 км
          // Прогнозируем точку на 50 км вперед
          const dLat = lat2 - lat1;
          const dLng = lng2 - lng1;
          const dist_km = 50;
          const norm = Math.sqrt(dLat * dLat + dLng * dLng);
          let lat3 = lat2, lng3 = lng2;
          if (norm > 0.00001) {
            lat3 = lat2 + dLat / norm * (dist_km / 111);
            lng3 = lng2 + dLng / norm * (dist_km / (111 * Math.cos(lat2 * Math.PI / 180)));
          }
          // --- Маркер ---
          marker = new google.maps.Marker({
            position: { lat: lat1, lng: lng1 },
            map,
            title: p.text,
            icon: { url: iconUrl, scaledSize: new google.maps.Size(32, 28) },
            opacity: 1
          });
          // --- Линия движения ---
          line = new google.maps.Polyline({
            path: [ { lat: lat1, lng: lng1 }, { lat: lat1, lng: lng1 } ],
            geodesic: true,
            strokeColor: '#e53935',
            strokeOpacity: 0.9,
            strokeWeight: 3,
            icons: [{
              icon: {
                path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                scale: 3,
                strokeColor: '#e53935',
                fillColor: '#e53935',
                fillOpacity: 1
              },
              offset: '100%'
            }]
          });
          line.setMap(map);
          markers.push(marker);
          markers.push(line);
            // --- Анимация движения маркера по двум сегментам ---
            (function() {
                let t = 0;
                const steps1 = 100000; // кадров для первого сегмента (очень медленно)
                const steps2 = 100000; // кадров для прогноза (очень медленно)
                function animateShahedMove() {
                    t++;
                    if (t <= steps1) {
                        // Движение от начальной к второй точке
                        const frac = t / steps1;
                        const lat = lat1 + (lat2 - lat1) * frac;
                        const lng = lng1 + (lng2 - lng1) * frac;
                        marker.setPosition({ lat, lng });
                        line.setPath([ { lat: lat1, lng: lng1 }, { lat, lng } ]);
                        requestAnimationFrame(animateShahedMove);
                    } else if (t <= steps1 + steps2) {
                        // Движение по прогнозу
                        const frac = (t - steps1) / steps2;
                        const lat = lat2 + (lat3 - lat2) * frac;
                        const lng = lng2 + (lng3 - lng2) * frac;
                        marker.setPosition({ lat, lng });
                        line.setPath([ { lat: lat1, lng: lng1 }, { lat: lat2, lng: lng2 }, { lat, lng } ]);
                        requestAnimationFrame(animateShahedMove);
                    } else {
                        // Остановить на прогнозной точке
                        marker.setPosition({ lat: lat3, lng: lng3 });
                        line.setPath([ { lat: lat1, lng: lng1 }, { lat: lat2, lng: lng2 }, { lat: lat3, lng: lng3 } ]);
                    }
                }
                setTimeout(() => { animateShahedMove(); }, 100 + idx * 40);
            })();
          // --- Анимация движения маркера по двум сегментам ---
          let t = 0;
          const steps1 = 100000; // кадров для первого сегмента
          const steps2 = 100000; // кадров для прогноза
          function animateShahedMove() {
            t++;
            if (t <= steps1) {
              // Движение от начальной к второй точке
              const frac = t / steps1;
              const lat = lat1 + (lat2 - lat1) * frac;
              const lng = lng1 + (lng2 - lng1) * frac;
              marker.setPosition({ lat, lng });
              line.setPath([ { lat: lat1, lng: lng1 }, { lat, lng } ]);
              requestAnimationFrame(animateShahedMove);
            } else if (t <= steps1 + steps2) {
              // Движение по прогнозу
              const frac = (t - steps1) / steps2;
              const lat = lat2 + (lat3 - lat2) * frac;
              const lng = lng2 + (lng3 - lng2) * frac;
              marker.setPosition({ lat, lng });
              line.setPath([ { lat: lat1, lng: lng1 }, { lat: lat2, lng: lng2 }, { lat, lng } ]);
              requestAnimationFrame(animateShahedMove);
            } else {
              // Остановить на прогнозной точке
              marker.setPosition({ lat: lat3, lng: lng3 });
              line.setPath([ { lat: lat1, lng: lng1 }, { lat: lat2, lng: lng2 }, { lat: lat3, lng: lng3 } ]);
            }
          }
          setTimeout(() => { animateShahedMove(); }, 100 + idx * 40);
        // --- Анимация и прогноз траектории для ракет с направлением ---
        } else if (p.threat_type === 'raketa' && typeof p.lat2 === 'number' && typeof p.lng2 === 'number') {
          let t = 0;
          const steps = 60;
          const duration = 3000;
          const lat1 = p.lat, lng1 = p.lng, lat2 = p.lat2, lng2 = p.lng2;
          marker = new google.maps.Marker({
            position: { lat: lat1, lng: lng1 },
            map,
            title: p.text,
            icon: { url: iconUrl, scaledSize: new google.maps.Size(32, 28) },
            opacity: 0
          });
          // blue raketa line removed
          markers.push(marker);
          setTimeout(() => { marker.setOpacity(1); }, 80 + idx * 40);
          function animateRaketa() {
            t++;
            const frac = Math.min(1, t / steps);
            const lat = lat1 + (lat2 - lat1) * frac;
            const lng = lng1 + (lng2 - lng1) * frac;
            marker.setPosition({ lat, lng });
            if (frac < 1) {
              animationId = requestAnimationFrame(animateRaketa);
            }
          }
          setTimeout(() => { animateRaketa(); }, 100 + idx * 40);
        } else {
          marker = new google.maps.Marker({
            position: { lat: p.lat, lng: p.lng },
            map,
            title: p.text,
            icon: { url: iconUrl, scaledSize: new google.maps.Size(32, 28) },
            opacity: 0
          });
          markers.push(marker);
          setTimeout(() => { marker.setOpacity(1); }, 80 + idx * 40);
        }
        const safeText = encodeURIComponent(String(p.text ?? ''));
        const safeSource = encodeURIComponent(String(p.source ?? ''));
        const hideBtn = `<button class='hide-btn' onclick=\"hideMarker(${p.lat},${p.lng},'${safeText}','${safeSource}')\">Сховати</button>`;
        const infowindow = new google.maps.InfoWindow({
          content: `<div style=\"background:#23272f; color:#f4f6fa; border-radius:10px; padding:10px 8px; min-width:220px; max-width:340px; font-size:1.04rem; box-shadow:0 2px 12px #0008; border:1.5px solid #31343b;\">`
            + `<b>Повідомлення:</b><br>${p.text}<br><b>Час:</b> ${p.date ? p.date : ''}<br>${hideBtn}`
            + `</div>`
        });
        marker.addListener('click', () => {
          infowindow.open(map, marker);
        });
      });
      // Обновить список событий
      updateEventList(points);
    }
    function updateEventList(points) {
      const el = document.getElementById('eventList');
      if (!el) return;
      if (!points || !points.length) {
        el.innerHTML = `
          <div class="event" style="text-align: center;">
            <div class="event-info">
              <div class="event-description" style="color: var(--text2);">
                Подій не знайдено
              </div>
            </div>
          </div>`;
        return;
      }
      el.innerHTML = points.slice(0, 20).map(ev => {
        let iconUrl = ICONS[ev.threat_type] || ICONS.default;
        if (ev.marker_icon) {
          if (ev.marker_icon.startsWith('http') || ev.marker_icon.startsWith('/')) {
            iconUrl = ev.marker_icon;
          } else {
            iconUrl = '/static/' + ev.marker_icon;
          }
        }
        
        return `
          <div class="event" data-type="${ev.threat_type || 'default'}">
            <div class="event-icon">
              <img src="${iconUrl}" alt="${ev.threat_type || 'загроза'}">
            </div>
            <div class="event-info">
              <div class="event-title">${ev.place || 'Невідома локація'}</div>
              <div class="event-description">${ev.text || ''}</div>
              <div class="event-time">
                <span class="material-icons">schedule</span>
                ${ev.date || ''}
              </div>
            </div>
          </div>`;
      }).join('');
    }
    async function initMap() {
      const lightStyle = [
        { elementType: 'geometry', stylers: [{ color: '#ffffff' }] },
        { elementType: 'labels.text.stroke', stylers: [{ color: '#ffffff' }] },
        { elementType: 'labels.text.fill', stylers: [{ color: '#23272f' }] },
        { featureType: 'administrative', elementType: 'geometry', stylers: [{ color: '#e0e4ea' }] },
        { featureType: 'poi', elementType: 'geometry', stylers: [{ color: '#ffffff' }] },
        { featureType: 'road', elementType: 'geometry', stylers: [{ color: '#e0e4ea' }] },
        { featureType: 'road', elementType: 'geometry.stroke', stylers: [{ color: '#fbc02d' }] },
        { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#e3f2fd' }] },
        { featureType: 'landscape', elementType: 'geometry', stylers: [{ color: '#ffffff' }] }
      ];
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 6,
        center: { lat: 48.3794, lng: 31.1656 },
        styles: lightStyle
      });

      // --- Интеграция с alerts.in.ua ---
      let airAlarmLayer = null;
      async function fetchAirAlarms() {
        try {
          const res = await fetch('https://alerts.com.ua/api/states');
          const data = await res.json();
          return data.regions || {};
        } catch (e) { return {}; }
      }
      async function showAirAlarmsOnMap() {
        if (airAlarmLayer) airAlarmLayer.setMap(null);
        const regions = await fetchAirAlarms();
        // Границы регионов (GeoJSON)
        const geoRes = await fetch('https://alerts.com.ua/static/geo/ukraine_regions.json');
        const geo = await geoRes.json();
        airAlarmLayer = new google.maps.Data();
        airAlarmLayer.addGeoJson(geo);
        airAlarmLayer.setStyle(f => {
          let code = f.getProperty('id');
          if (!code && f.getProperty('ISO_3166_2')) code = f.getProperty('ISO_3166_2');
          if (code) code = code.toUpperCase();
          let alarm = false;
          if (code && regions[code]) alarm = regions[code].alert;
          if (!alarm && code && regions[code.toLowerCase()]) alarm = regions[code.toLowerCase()].alert;
          return {
            fillColor: alarm ? '#ffe082' : '#e0e4ea',
            fillOpacity: alarm ? 0.55 : 0.12,
            strokeColor: alarm ? '#e53935' : '#bdbdbd',
            strokeWeight: alarm ? 2 : 1,
            zIndex: alarm ? 2 : 1
          };
        });
        airAlarmLayer.setMap(map);
      }
      showAirAlarmsOnMap();
      setInterval(showAirAlarmsOnMap, 20000);

      await updateMarkers();
      setInterval(updateMarkers, 10000);
    }
    async function hideMarker(lat, lng, text, source) {
      lat = Math.round(lat * 1000) / 1000;
      lng = Math.round(lng * 1000) / 1000;
      await fetch('/hide_marker', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ lat, lng, text: decodeURIComponent(text), source: decodeURIComponent(source) })
      });
      prevTimeRange = null;
      await updateMarkers();
    }
    window.onload = () => { initMap(); };
  </script>
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCNvHPPImGhTBA7NyOL7kNvfFe4bTIRpGs&callback=initMap&language=uk"></script>
</body>
</html>
